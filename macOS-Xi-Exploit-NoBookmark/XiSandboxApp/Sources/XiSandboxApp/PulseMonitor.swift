import Foundation

struct XiPulseMonitor {

    /// Belirtilen dosyayÄ± aralÄ±klarla okuyarak sandbox / SIP durumunu gÃ¶zlemler.
    static func run(path: String, interval: UInt32 = 3) {
        print("""
        ÎžPulseMonitor activated
          Target path: \(path)
          PID: \(getpid())
          SIP status: \(checkSIP() ? "ðŸ›¡ Enabled" : "âš ï¸ Disabled")
          Sandbox: \(isSandboxed() ? "ðŸ”’ Yes" : "ðŸ”“ No")
          Begin monitoring Îž-pulseâ€¦

        """)
        while true {
            print("â± \(Date())")
            if FileManager.default.fileExists(atPath: path) {
                do {
                    let bytes = try Data(contentsOf: URL(fileURLWithPath: path))
                    print("âœ… Îž minted [\(bytes.count) bytes]")
                } catch {
                    print("âŒ Îž blocked: \(error.localizedDescription)")
                }
            } else {
                print("âŒ File missing.")
            }
            sleep(interval)
        }
    }

    // MARK: â€“ Helpers
    private static func isSandboxed() -> Bool {
        ProcessInfo.processInfo.environment["APP_SANDBOX_CONTAINER_ID"] != nil
    }

    private static func checkSIP() -> Bool {
        let pipe = Pipe()
        let task = Process()
        task.launchPath = "/usr/bin/csrutil"
        task.arguments   = ["status"]
        task.standardOutput = pipe
        do { try task.run() } catch { return false }
        let data = pipe.fileHandleForReading.readDataToEndOfFile()
        return (String(data: data, encoding: .utf8) ?? "").contains("enabled")
    }
}
